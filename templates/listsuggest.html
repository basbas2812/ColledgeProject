{% extends "base.html" %}
{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö{% endblock %}
{% block content %}

<main class="container mt-4">
  <div class="section-header">
    <i class="fas fa-user-md"></i>
    <h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</h1>
  </div>

  {% if consultations %}
  <div class="consultation-list">
    {% for row in consultations %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <strong>‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ #{{ row.consultationId }}</strong>
        <span class="badge bg-light text-dark float-end">{{ row.consultationStatus or '‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö' }}</span>
      </div>

      <div class="card-body">
        <!-- üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <p><i class="fas fa-user"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {{ row.username }}</p>
        <p><i class="far fa-calendar-alt"></i> {{ row.consultationDate }}</p>

        <!-- üîπ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ -->
        {% if row.sortedGroups and row.sortedGroups|length > 0 %}
          {% for g in row.sortedGroups %}
            {% set disease = g["disease"] %}
            {% set items = g["items"] %}
            <div style="margin-bottom:20px; padding:15px; border:1px solid #ccc; border-radius:10px;">

              {% if disease == "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ" %}
                <!-- üîπ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ -->
                <h4 style="color:#d9534f;">ü¶† ‡πÇ‡∏£‡∏Ñ: {{ disease }}</h4>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
                  {% for item in items %}
                  <div style="text-align:center;">
                    {% if item["image"] %}
                      <img src="{{ url_for('static', filename=item['image'].strip()) }}" 
                           alt="{{ item['‡πÑ‡∏ü‡∏•‡πå'] }}" class="img-preview">
                    {% endif %}
                    <small>{{ item["‡πÑ‡∏ü‡∏•‡πå"] }}</small><br>
                    <small style="color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {{ item["‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}%</small>
                  </div>
                  {% endfor %}
                </div>

              {% else %}
                <!-- üîπ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ -->
                <h4 style="color:#2e7d32;">ü¶† ‡πÇ‡∏£‡∏Ñ: {{ disease }} ({{ g["count"] }} ‡∏†‡∏≤‡∏û)</h4>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
                  {% for item in items %}
                  <div style="text-align:center;">
                    {% if item["image"] %}
                      <img src="{{ url_for('static', filename=item['image'].strip()) }}" 
                           alt="{{ item['‡πÑ‡∏ü‡∏•‡πå'] }}" class="img-preview">
                    {% endif %}
                    <small>{{ item["‡πÑ‡∏ü‡∏•‡πå"] }}</small><br>
                    <small style="color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {{ item["‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}%</small>
                  </div>
                  {% endfor %}
                </div>
                <p><b>üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> {{ items[0]["‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"] or items[0]["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
                <p><b>üíä ‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> {{ items[0]["‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
                <p><b>üß™ ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</b> {{ items[0]["‡∏¢‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
                <p><b>üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤:</b> {{ items[0]["‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <!-- ‚úÖ fallback: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å ML ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ -->
          <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <h4 style="color:#d9534f;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡∏ä‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</p>
            <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
              {% if row.consultationImage %}
                {% for img in row.consultationImage.split('|') %}
                <div style="text-align:center;">
                  <img src="{{ url_for('static', filename=img.strip()) }}" alt="uploaded image"
                    style="max-width:120px; border-radius:6px; display:block; margin-bottom:5px;">
                  <small>{{ img.split('/')[-1] }}</small>
                </div>
                {% endfor %}
              {% else %}
                <p style="color:#999;">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤</p>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <!-- üîπ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏ß‡∏° -->
        <div class="mb-4">
          <h3 class="section-header mb-3"><i class="fas fa-microscope"></i> üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
          <p><b>üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°:</b> {{ row.summary or '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ' }}</p>
          <p><b>üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</b> {{ row.avgConfidence }}%</p><br>
        </div>

        <!-- üîπ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <div class="consult-message mb-3">
          <h5 class="section-title">üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
          <p>{{ row.consultationMessage or '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°' }}</p>
        </div>

        <!-- üîπ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç -->
        <div class="consult-section expert-section">
          <h5><i class="fas fa-reply"></i> ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
          <form action="{{ url_for('add_advice_simple', adviceid=row.adviceId) }}" method="POST" class="expert-form">
            <label for="message-{{ row.adviceId }}"><i class="fas fa-comment-dots"></i> ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
            <textarea name="message" id="message-{{ row.adviceId }}" rows="3" class="form-control"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö..." required></textarea>
            <button type="submit" class="btn btn-success mt-2">
              <i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    <div>
      <h4>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</h4>
      <p>‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏≤</p>
    </div>
  </div>
  {% endif %}
</main>
{% endblock %}
