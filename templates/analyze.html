{% extends "base.html" %} {% block title %}‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å{% endblock %} {% block
content %}

<main class="container">
  <h2>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏û‡∏∑‡∏ä</h2>
  <br />
  <h3>
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏Ñ‡∏•‡∏≤‡∏î‡∏Ñ‡∏•‡∏∑‡πà‡∏ô
  </h3>
  <h3>
    *‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∑‡∏ä‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ
    ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
  </h3>
  <br />
  <form id="uploadForm" enctype="multipart/form-data">
    <label for="plantType"><b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä:</b></label>
    <select name="plantType" id="plantType" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡∏ä --</option>
      <option value="‡∏Ç‡πâ‡∏≤‡∏ß">‡∏Ç‡πâ‡∏≤‡∏ß</option>
      <option value="‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
      <option value="‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®">‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®</option>
      <option value="‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î">‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î</option>
      <option value="‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á">‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á</option>
      <option value="orther">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
    </select>

    <br /><br />
    <input type="file" name="file" id="fileInput" multiple required />
    <button type="submit" id="analyzeBtn">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
  </form>

  <!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
  <div id="result" style="
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
    ">
    <p><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</strong></p>
  </div>

  <div id="consultControls" style="margin-top: 20px"></div>
</main>

<script>
  const plantSelect = document.getElementById("plantType");
  const analyzeBtn = document.getElementById("analyzeBtn");

  function updateAnalyzeButton() {
    const selected = plantSelect.value;
    if (selected === "" || selected === "orther") {
      analyzeBtn.style.display = "none";
    } else {
      analyzeBtn.style.display = "inline-block";
    }
  }

  updateAnalyzeButton();
  plantSelect.addEventListener("change", updateAnalyzeButton);

  let lastUploadFiles = [];
  let lastAnalysis = null;

  document.getElementById("uploadForm").onsubmit = async (e) => {
    e.preventDefault();

    const formData = new FormData();
    const plantType = document.getElementById("plantType").value;
    const files = e.target.file.files;
    lastUploadFiles = Array.from(files);

    formData.append("plantType", plantType);
    for (let i = 0; i < files.length; i++) {
      formData.append("file", files[i]);
    }

    const analyzablePlants = ["‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á", "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î", "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á"];
    const resultBox = document.getElementById("result");

    if (plantType === "orther" || !analyzablePlants.includes(plantType)) {
      resultBox.innerHTML = `
        <div class="analysis-card">
          <h3>üìå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
          <p style="color:#d9534f;"><b>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</b></p>
          <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡∏ä‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</p>
        </div>`;
      showConsultForm();
      return;
    }

    const res = await fetch("/analyze_plant", { method: "POST", body: formData });
    const data = await res.json();
    lastAnalysis = data;

    if (data.error) {
      resultBox.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error}</div>`;
      showConsultForm();
      return;
    }

    const results = data["‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏†‡∏≤‡∏û"] || [];
    const avgConfidence = data["‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const summary = data["‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°"] || [];

    let html = `
      <div class="analysis-card">
        <h3>üìå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
        <p><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏û:</b> ${results.length}</p>
        <p><b>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</b> ${avgConfidence}%</p>
        <b>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°:</b>
        <ul>
    `;

    if (Array.isArray(summary)) {
      summary.forEach(item => {
        html += `<li>${item}</li>`;
      });
    }

    html += `
        </ul>
        <hr>
      </div>
    `;

    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏Ñ
    const grouped = {};
    results.forEach((item, index) => {
      const disease = item["‡πÇ‡∏£‡∏Ñ"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      if (!grouped[disease]) {
        grouped[disease] = { details: item, images: [], items: [] };
      }
      const fileObj = lastUploadFiles[index];
      const imgURL = fileObj ? URL.createObjectURL(fileObj) : "";
      grouped[disease].images.push({ name: item["‡πÑ‡∏ü‡∏•‡πå"], url: imgURL });
      grouped[disease].items.push(item);
    });

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏Ñ
    for (const [disease, gdata] of Object.entries(grouped)) {
      html += `
        <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;">
          <h4 style="color:${disease === "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ" ? "#d9534f" : "#2e7d32"};">ü¶† ‡πÇ‡∏£‡∏Ñ: ${disease}</h4>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
            ${gdata.images.map((img, idx) => `
              <div style="text-align:center;">
                <img src="${img.url}" alt="${img.name}" class="img-preview">
                <small>${img.name}</small><br>
                <small style="color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${gdata.items[idx]["‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}%</small>
              </div>
            `).join("")}
          </div>
          ${disease !== "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ" ? `
            <p><b>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> ${gdata.details["‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"] || gdata.details["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</p>
            <p><b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> ${gdata.details["‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</p>
            <p><b>‡∏¢‡∏≤:</b> ${gdata.details["‡∏¢‡∏≤"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</p>
            <p><b>‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤:</b> ${gdata.details["‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤"] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</p>
          ` : ""}
        </div>
      `;
    }

    html += `<p style="margin-top:10px; color:#555;">‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>`;
    resultBox.innerHTML = html;

    showConsultForm();
  };

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  async function showConsultForm() {
    const expertsRes = await fetch("/get_experts");
    const experts = await expertsRes.json();
    const options = experts.map(ex => `<option value="${ex.expertId}">${ex.expertName}</option>`).join("");

    document.getElementById("consultControls").innerHTML = `
      <div class="consult-card">
        <h4>üí¨ ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h4>
        <label for="expertSelect"><b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç:</b></label>
        <select id="expertSelect" class="form-control">${options}</select>
        <label for="userMessage" style="margin-top:10px;"><b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</b></label>
        <textarea id="userMessage" rows="3" class="form-control" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
        <button id="sendConsult" class="btn-consult">üì© ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</button>
      </div>
    `;

    document.getElementById("sendConsult").onclick = async () => {
      const sendBtn = document.getElementById("sendConsult");
      sendBtn.disabled = true;
      sendBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

      const expertId = document.getElementById("expertSelect").value;
      const message = document.getElementById("userMessage").value;

      const consultForm = new FormData();
      lastUploadFiles.forEach((file) => consultForm.append("file", file));
      consultForm.append("Mresult", JSON.stringify(lastAnalysis));
      consultForm.append("status", "‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
      consultForm.append("expertId", expertId);
      consultForm.append("message", message);

      try {
        const res = await fetch("/request_consult", {
          method: "POST",
          body: consultForm,
        });
        const result = await res.json();

        if (result.success) {
          alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: " + result.consultationId);
          document.getElementById("consultControls").innerHTML = `
        <div class="alert alert-success">
          ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${result.consultationId})
        </div>
      `;
        } else {
          alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (result.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ"));
          sendBtn.disabled = false;
          sendBtn.innerText = "üì© ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤";
        }
      } catch (err) {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        sendBtn.disabled = false;
        sendBtn.innerText = "üì© ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤";
      }
    };

  }
</script>
{% endblock %}