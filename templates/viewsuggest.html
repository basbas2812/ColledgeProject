{% extends "base.html" %}
{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å{% endblock %}
{% block content %}

<main class="container mt-4">
  {% if consultations %}
  <h2 class="mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

  {% for row in consultations %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <strong>‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ #{{ row.consultationId }}</strong>
      <span class="badge bg-light text-dark float-end">{{ row.consultationStatus }}</span>
    </div>

    <div class="card-body">

      <!-- üîπ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ -->
      {% if row.sortedGroups and row.sortedGroups|length > 0 %}
      {% for g in row.sortedGroups %}
      {% set disease = g["disease"] %}
      {% set items = g["items"] %}
      <div style="margin-bottom:20px; padding:15px; border:1px solid #ccc; border-radius:10px;">

        {% if disease == "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ" %}
        <!-- üîπ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ -->
        <h4 style="color:#d9534f;">ü¶† ‡πÇ‡∏£‡∏Ñ: {{ disease }}</h4>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
          {% for item in items %}
          <div style="text-align:center;">
            {% if item["image"] %}
            <img src="{{ url_for('static', filename=item['image'].strip()) }}" alt="{{ item['‡πÑ‡∏ü‡∏•‡πå'] }}" class="img-preview">
            {% endif %}
            <small>{{ item["‡πÑ‡∏ü‡∏•‡πå"] }}</small><br>
            <small style="color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {{ item["‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}%</small>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <!-- üîπ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ -->
        <h4 style="color:#2e7d32;">ü¶† ‡πÇ‡∏£‡∏Ñ: {{ disease }} ({{ g["count"] }} ‡∏†‡∏≤‡∏û)</h4>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
          {% for item in items %}
          <div style="text-align:center;">
            {% if item["image"] %}
            <img src="{{ url_for('static', filename=item['image'].strip()) }}" alt="{{ item['‡πÑ‡∏ü‡∏•‡πå'] }}" class="img-preview">
            {% endif %}
            <small>{{ item["‡πÑ‡∏ü‡∏•‡πå"] }}</small><br>
            <small style="color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: {{ item["‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"] or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}%</small>
          </div>
          {% endfor %}
        </div>
        <p><b>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</b> {{ items[0]["‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"] or items[0]["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
        <p><b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤:</b> {{ items[0]["‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
        <p><b>‡∏¢‡∏≤:</b> {{ items[0]["‡∏¢‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
        <p><b>‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤:</b> {{ items[0]["‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤"] or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" }}</p>
        {% endif %}
      </div>
      {% endfor %}

      {% else %}
      <!-- ‚úÖ fallback: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å ML ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ -->
      <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;">
        <h4 style="color:#d9534f;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h4>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡∏ä‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0;">
          {% if row.consultationImage %}
          {% for img in row.consultationImage.split('|') %}
          <div style="text-align:center;">
            <img src="{{ url_for('static', filename=img.strip()) }}" alt="uploaded image"
              style="max-width:120px; border-radius:6px; display:block; margin-bottom:5px;">
            <small>{{ img.split('/')[-1] }}</small>
          </div>
          {% endfor %}
          {% else %}
          <p style="color:#999;">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤</p>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- üîπ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏ß‡∏° -->
      <div class="mb-4">
        <h3 class="section-header mb-3"><i class="fas fa-microscope"></i> üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
        <p><b>üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°:</b> {{ row.summary or '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ' }}</p>
        <p><b>üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</b> {{ row.avgConfidence }}%</p><br>
      </div>

      <!-- üîπ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
      <div class="consult-message mb-3">
        <h5 class="section-title">üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
        <p>{{ row.consultationMessage or '-' }}</p>
      </div>

      <!-- üîπ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç -->
      <div class="consult-meta">
        <h5 class="section-title">üë®‚Äç‚öïÔ∏è ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h5>
        {% if row.adviceMessage %}
          <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö -->
          <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:</b> {{ row.adDateTime or '-' }}</p>
        {% else %}
          <!-- ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ -->
          <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</b> {{ row.consultationDate }}</p>
        {% endif %}
        <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> {{ row.consultationStatus }}</p>
        <p><b>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</b> {{ row.adviceMessage or '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö' }}</p>
        <p><b>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç:</b> {{ row.expertName or '-' }}</p>
      </div>
    </div>
  </div>
  {% endfor %}

  {% else %}
  <div class="alert alert-info mt-4">
    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
  </div>
  {% endif %}
</main>

{% endblock %}